Lichess Bot Setup:
    - Account: tombot1234
    - Engine: v15_engine (UCI protocol)
    - Config: lichess-bot-master/config.yml
    - Time controls: blitz, rapid, classical
    - Matchmaking: auto-challenges other bots every 1 min; offers rematch after a win
    - Uses Lichess opening explorer (masters) and online endgame tablebases (7-piece)
    - Run with: cd lichess-bot-master && python lichess-bot.py


Running the Bot:
    # Compile all C engines (only needed once, or after code changes):
    cd c_rewrite && make

    # Run the Lichess bot (config points to v15):
    cd lichess-bot-master && python lichess-bot.py

    # Test the engine directly via UCI:
    echo -e "uci\nisready\nposition startpos moves e2e4 e7e5\ngo depth 10\nquit" | ./c_rewrite/v15_engine

    # Run tournament at fixed depth:
    python tests/uci_tournament.py --engine1 c_rewrite/v14_engine --engine2 c_rewrite/v15_engine --positions 15 --depth 10

    # Old v12 Python engine (still available):
    python -c "import chess; from bots.v12 import get_best_move; b = chess.Board(); print(get_best_move(b, depth=7))"


 API Key - Set LICHESS_BOT_TOKEN env var (see .env file)

 GitHub - https://github.com/tcberkley/ChessBot


Missing Features / To-Do:
    Ranked by estimated Elo gain. Ranges are rough — 30-game samples have wide CIs.
    Items marked DONE were implemented in v16.

    --- Search ---

    Check extensions                       DONE (already in v15)
        When the side to move is in check, extend the search by 1 ply. Prevents
        missing forced sequences that begin with a check.

    50-move rule / draw detection          DONE (v16)
        Halfmove clock now parsed and tracked; engine returns draw score at 100.
        Insufficient material detection (KK, KBK, KNK) also returns 0.

    Pondering                              ~20-40 Elo
        Search during the opponent's clock on the expected reply. If the opponent
        plays that move, the search result is reused immediately — effectively
        doubles thinking time for free. Complicates time management; config.yml
        already has ponder: false ready to flip.

    Score instability / time extension     DONE (v16)
        If best move is stable for 3+ depths with small score swing, exit search
        early once past 40% of time budget. (Time-controlled mode only.)

    Singular extensions                    ~10-20 Elo
        If the TT move at a node is significantly better than all alternatives
        (margin test against reduced search), extend it by 1 ply. Complex to
        implement correctly without causing search explosions.

    Internal Iterative Deepening (IID)     DONE (v16)
        At PV nodes with no TT move and depth >= 5, run a depth-2 shallow search
        first for move ordering.

    Aspiration window gradual widening     DONE (v16)
        On aspiration failure, widen gradually (±50 → ±150 → ±450 → full)
        instead of jumping straight to a full-width re-search.

    --- Evaluation ---

    Rook behind passed pawn                DONE (v16)
        +20 bonus when a rook is behind its own passed pawn on the same file.

    Pawn shield quality                    DONE (v16)
        Replaced flat shield count with quality scoring: +15 for immediate pawn,
        +8 for one step advanced. Only counts pawns directly in front of king
        (not same-rank adjacent pawns).

    50-move / insufficient material eval   DONE (v16)
        Eval returns 0 for KK, KBK, KNK configurations.

    Tempo / side-to-move bonus             DONE (v17)
        +10cp added to static_eval in negamax futility block only (NOT in
        quiescence). Correctly avoids the v16 stand_pat bug.

    Connected rooks                        DONE (v16)
        +15 bonus for two rooks on the same open file or rank (no pieces between).

    Pawn islands                           DONE (v16)
        -8 cp per extra island beyond the first.

    King mobility in endgame               DONE (v16)
        +3 cp per safe king move in endgame phase.

    Candidate passed pawns                 ~5-10 Elo
        Pawns that could become passed with the right pawn exchanges. Initial
        implementation removed — too error-prone without proper forward-only
        support counting.

    Weak squares / holes                   ~5-10 Elo
        Squares that can never be defended by a pawn again (after pawn advances)
        invite enemy piece occupation. Especially dangerous near the king.


    --- Infrastructure ---


    UCI multipv                            0 Elo (analysis only)
        Return N best moves. Useful for analysis; no effect on play strength.

    UCI go movetime                        DONE (already in v16)
        Parsing confirmed present in v16/v17. Correctly sets time_budget_ms.

    SEE (Static Exchange Evaluation)       DONE (v17)
        Swap algorithm. Used in capture ordering and qsearch filter.

    King attack count scoring              DONE (v17)
        Danger weights Q=5,R=3,B/N=2,P=1. Penalty = danger²/4 capped 150cp.

    Adaptive null move R                   DONE (v17)
        R = 3 + depth/6 instead of fixed R=3.

    Countermove heuristic                  DONE (v17)
        Indexed by opponent's last move (piece, to_sq). Score: 700k.

    History malus + gravity                DONE (v17)
        Malus for quiet moves that fail. Gravity scaling prevents overflow.

    Bad bishop penalty                     DONE (v17)
        -5 cp per own pawn on same color squares as bishop.

    Pawn hash table                        ~10-20 Elo (v18)
        Deferred: requires evaluate_side refactor to return own_passed_bb.

    Singular extensions                    ~10-20 Elo
        Run reduced search excluding TT move; if it fails low, extend TT move.

    Probcut                                ~5-8 Elo
        At non-PV nodes depth>=5: depth-4 search with wide window to prune.


Bot Version History:
    Random Bot - Makes a random move every turn

    mini_max_v1 - Uses mini max algo to find best position based on only material

    mini_max_v2 - Uses mini max algo to find best position based on material and position of knights and pawns, but does so incorrectly

    alpha_beta_mm_v3 - Uses alpha/beta pruning to speed up algo. Incentivizes good positioning for queen and bishop

    endgame_faster_v4 - Searches deeper in the endgame, optimizes get_adj_material algo

    castle_bot_v5 - rewards abaility to castle (1 point per side), rewards castling more (5 points)

    king_safety_v6 - rewards king safety, removes castling incentive, fixes material evaluation error

    quiescence_v7 - adds quiescence search, transposition table, repetition penalty, passed pawns, rook mobility, fixes castling bug from v6

    opening_book_v8 - plays e4/d4 as White and e5/d5 as Black on move 1, adds killer move heuristic,
                      null move pruning, check extensions, pawn structure penalties (doubled/isolated),
                      bishop pair bonus, transposition table size limit

    iterative_v9 - adds iterative deepening, late move reductions (LMR), full piece-square tables
                   for all pieces (with middlegame/endgame tapering for pawns and kings), king
                   centralization and proximity bonus in endgame, tapered evaluation using game phase

    optimized_v10 - major efficiency overhaul (~38x faster than v9). Negamax rewrite (eliminates
                    duplicated White/Black branches), TT stores best move for move ordering,
                    principal variation search (PVS), aspiration windows, flattened 1D PST tables,
                    bitboard passed pawn detection, history heuristic, MVV-LVA capture ordering,
                    LMR bug fix (capture check before push), optimized eval using board.pieces()

    time_managed_v11 - adds time-managed iterative deepening on top of v10. Dynamically allocates
                       time per move based on clock/increment/move number. Searches deeper when
                       more time is available, shallower in time pressure. Global time abort inside
                       negamax (checks every 2048 nodes) prevents overspending on a single move.
                       Minimum search depth of 5 ensures move quality.

    v12 - search efficiency improvements on top of v11. Futility pruning (skip quiet
                       moves at depth 1-2 when static eval + margin < alpha), quiescence move
                       ordering (MVV-LVA on captures), removed expensive board.is_game_over()
                       (detect checkmate/stalemate from empty legal moves), aspiration time guard
                       (skip re-search if >50% budget used), log-based LMR (bigger reductions for
                       later moves), lazy gives_check (only compute for LMR-eligible moves),
                       set-based isolated pawn detection. ~25% fewer nodes at same depth.
                       Deployed on Lichess via lichess-bot-master (account: tombot1234)

    v13 - full C rewrite of v12. Uses BBC (Bit Board Chess) by Code Monkey King as the
                       foundation for magic bitboard move generation, with v12's evaluation and
                       search logic ported on top. Speaks UCI protocol instead of homemade.
                       ~20x faster than v12 on PyPy (~1.3M nodes/sec), reaching depth 16 in
                       blitz time controls (v12 maxed at depth 10-11). All v12 features ported:
                       tapered eval, PSTs, passed pawns, mobility, pawn structure, bishop pair,
                       king safety, castling bonuses, king endgame, negamax with PVS, null move
                       pruning, LMR, futility pruning, aspiration windows, TT with best_move,
                       opening book, time management. Added distance-to-mate scoring.
                       Source: c_rewrite/v13_engine.c (~3900 lines)
                       Binary: c_rewrite/v13_engine (compiled with gcc -O3)

    v14 - search and time management improvements on top of v13. More aggressive time
                       usage (moves_left: 40/30/20 → 25/20/15, max budget cap: 20% → 33% of
                       clock, check_time threshold: 80% → 90%, depth-skip threshold: 40% → 55%,
                       aspiration bail threshold: 50% → 70%). Algorithm: reverse futility pruning
                       added (at depth ≤ 3, if static_eval - 100*depth ≥ beta, return early).
                       Efficiency: TIME_CHECK_INTERVAL doubled (2048 → 4096 nodes), TT prefetch
                       via __builtin_prefetch, quiescence pre-filter (break at first non-capture
                       before copy_board — eliminates ~25 wasted memcpys per qsearch node),
                       TT struct compacted 24→16 bytes (hash32 + signed char depth + uchar flag)
                       doubling TT entries to 4M (64MB) with 4 entries per cache line. Compiler:
                       -O3 -march=native -fomit-frame-pointer. Eval identical to v13 (eval changes
                       tested but reverted — hurt fixed-depth play). Lichess bot now offers
                       immediate rematch after a win. 50-game fixed-depth test (depth 10) vs v13:
                       v14 52% (+20 =12 -18). Depth-12 benchmark vs v13: 2.14x faster, 0.538x
                       nodes (46% fewer nodes searched).
                       Source: c_rewrite/v14_engine.c
                       Binary: c_rewrite/v14_engine (compiled with gcc -O3 -march=native)

    v15 - evaluation improvements on top of v14. New terms: rooks on open/semi-open
                       files (+20/+10), rook on 7th rank (+25 EG/+15 MG), king safety
                       open-file penalty near king (−10 open/−5 semi-open, MG only, half-
                       weight), knight outpost bonus (+15, +10 extra if pawn-defended),
                       backward pawn penalty (−10), tapered PSTs for bishops/rooks/queens
                       (separate MG and EG tables). Search and time management identical
                       to v14. 30-game fixed-depth test (depth 10) vs v14: v15 56.7%
                       (+13 =8 -9). Avg move time 108ms vs 101ms (+7%), nodes 287k vs
                       272k (+6%) — richer eval shifts pruning thresholds slightly.
                       Reaching depth 15-18 in blitz (vs v13's depth 16).
                       Source: c_rewrite/v15_engine.c
                       Binary: c_rewrite/v15_engine (compiled with gcc -O3 -march=native)

    v17 - search and evaluation improvements on top of v16. Search: adaptive null
                       move R (R = 3 + depth/6 instead of fixed R=3; at depth 12, R=5),
                       countermove heuristic (quiet move indexed on opponent's last
                       move piece/to-square, scored 700k — between killer 1 and history),
                       history malus + gravity (quiet moves that don't improve alpha take
                       a malus of depth²/2 with gravity scaling; bonus uses gravity:
                       bonus - h*bonus/16384 to prevent overflow), tempo bonus correctly
                       placed in negamax futility static_eval only (+10cp, NOT in
                       quiescence — fixes the v16 attempt that broke stand_pat).
                       Eval: SEE (Static Exchange Evaluation) — standard swap algorithm
                       (~80 lines); used for (1) capture ordering: winning SEE>=0 scored
                       at 1M+MVV-LVA, losing SEE<0 scored at 500k+MVV-LVA (below killers),
                       (2) quiescence: skip captures where SEE<0 (replaces crude 900cp
                       delta for per-capture filtering); bad bishop penalty (-5 cp per own
                       pawn on same color squares as bishop); king attack count scoring —
                       counts enemy pieces attacking the 8 squares around the king with
                       weights (Q=5, R=3, B=2, N=2, P=1), penalty = danger²/4 capped at
                       150cp, middlegame only. Pawn hash table deferred to v18
                       (requires evaluate_side refactor to pass passed_bb out).
                       50-game movetime-100ms tournament vs v16: v17 56.0%
                       (17W / 11L / 22D), estimated +42 Elo.
                       Source: c_rewrite/v17_engine.c
                       Binary: c_rewrite/v17_engine (compiled with gcc -O3 -march=native)
                       Deployed: Hetzner CPX11 server (178.156.243.29, Ubuntu 24.04, x86 AMD)
                       as a systemd service. See server_details.txt for full deployment info.

    v16 - search and evaluation improvements on top of v15. Search: 50-move rule
                       (halfmove clock now parsed and tracked; draw returned at >=100
                       half-moves), aspiration window gradual widening (±50 → ±150 →
                       ±450 → full on failure instead of jumping straight to full),
                       score instability / easy-move detection (exit search early if
                       best move stable 3+ depths with swing <30cp and past 40% of
                       budget), Internal Iterative Deepening (at PV nodes with no TT
                       hit and depth>=5, run depth-2 shallow search for move ordering).
                       Eval: rook behind passed pawn (+20), pawn shield quality scoring
                       (rank_dist=1: +15, rank_dist=2: +8, replaces flat shield count),
                       connected rooks (+15 if two rooks share clear file or rank),
                       pawn islands penalty (-8 per island beyond the first), king
                       mobility in endgame (+3 per safe move), insufficient material
                       draw detection (KK, KBK, KNK → 0). NOTE: tempo bonus (+10 for
                       side to move) was implemented and removed — adding it inside
                       evaluate() breaks quiescence: stand_pat gets +10 but captures
                       don't, so the engine rejects any capture worth <20cp. Candidate
                       passed pawns were also attempted but removed — the support-count
                       logic was too broad. 30-game fixed-depth test (depth 10) vs v15:
                       approximately equal (+9 =12 -8 for v15, 51.7%). Node ratio
                       0.97x v15 — features add search complexity but pruning offsets.
                       Source: c_rewrite/v16_engine.c
                       Binary: c_rewrite/v16_engine (compiled with gcc -O3 -march=native)
                       Deployed: Hetzner CPX11 server (178.156.243.29, Ubuntu 24.04, x86 AMD)
                       as a systemd service. See server_details.txt for full deployment info.
